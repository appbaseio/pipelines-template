{
    "enabled": true,
    "description": "Pipeline to save search to an Elasticsearch index",
    "routes": [
        {
            "path": "/saved-search/_reactivesearch",
            "method": "POST",
            "classify": {
                "category": "reactivesearch"
            }
        }
    ],
    "envs": {
        "category": "reactivesearch",
        "index": [
            "test"
        ],
        "saved_search_index": "${{ SAVED_SEARCH_INDEX }}",
        "saved_search_credentials": "${{ SAVED_SEARCH_CREDENTIALS }}"
    },
    "stages": [
        {
            "use": "authorization"
        },
        {
            "id": "modify_request",
            "script": "function handleRequest() {const reqBody = JSON.parse(context.request.body);return {    request: {        ...context.request, body: JSON.stringify({            ...reqBody, query:                [...reqBody.query, { id: 'search2' }]        })    }};\n}"
        },
        {
            "id": "save_search",
            "async": true,
            "script": "async function handleRequest() {try {    const res = await fetch(`http://${context.envs.origin}/${context.envs.saved_search_index}/_doc`,        {            method: 'POST', body: context.request.body, headers: {                'Content - Type': 'application/ json',                'Authorization': `Basic ${btoa(context.envs.saved_search_credentials)}`            }        });} catch (e) { console.log('error', e); } return {};\n}"
        },
        {
            "use": "reactivesearchQuery",
            "needs": [
                "save_search"
            ]
        },
        {
            "use": "elasticsearchQuery"
        }
    ]
}